<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Musings of an 8-bit Vet]]></title>
  <link href="http://bayendor.github.io/atom.xml" rel="self"/>
  <link href="http://bayendor.github.io/"/>
  <updated>2015-01-16T10:32:35-07:00</updated>
  <id>http://bayendor.github.io/</id>
  <author>
    <name><![CDATA[David Bayendor]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Managing Rails Environment Variables]]></title>
    <link href="http://bayendor.github.io/blog/2015/01/16/managing-rails-environment-variables/"/>
    <updated>2015-01-16T08:48:03-07:00</updated>
    <id>http://bayendor.github.io/blog/2015/01/16/managing-rails-environment-variables</id>
    <content type="html"><![CDATA[<p>Environment variables are a set of dynamic named values that affect the way running processes behave on a computer.
In almost all operating systems each process has a private set of environment variables, and by default when a
process is created it inherits a duplicate environment from the parent process, except where explicit changes are made.</p>

<p>Typically environment variables are set in your <code>.bash_profile</code>, <code>.bashrc</code>, or <code>.zshrc</code>.</p>

<p>Examples include <code>$PATH, $PWD, $SHELL, $EDITOR</code>.  Typing <code>ENV</code> in your terminal will show you all the environment
variables currently set.  You can access environment variables using <code>echo $&lt;env_var_name&gt;</code> or if you don&rsquo;t know the
exact name of the environment variable by piping the output of env to grep (or ack, or ag), for example:</p>

<figure class='code'><figcaption><span>Piping ENV output to grep</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">ENV</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">ssh</span>
</span><span class='line'><span class="n">SSH_AUTH_SOCK</span><span class="o">=/</span><span class="n">private</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">launchd</span><span class="p">.</span><span class="n">okWDAcFz3u</span><span class="o">/</span><span class="n">Listeners</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Rails framework also relies on environment variables, typically to set TEST, DEVELOPMENT or PRODUCTION modes.
These variables are stored in a hash named <code>ENV</code>, and they can be explored from the Rails console:</p>

<figure class='code'><figcaption><span>Fetching environment values from the ENV hash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;development&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;ve ever found that a passing test suite suddenly is failing for no reason, it could be because the rails environment
variable is not running as &ldquo;test&rdquo;, but as &ldquo;development&rdquo;.  The takeaway here is: Environment Variables Configure Behavior</p>

<p>They also configure other applications, such as the secret token to set Rails sessions, and the keys used to access
cloud services like AWS, or email services like Send Grid.  Often we, unknowingly set these environment variables in
files that are committed to Github, which is open source.</p>

<p>This has become such a problem that services such as AWS monitor repos looking to see if AWS credentials have been
compromised, and will send a warning notice to the credential owners without minutes of the git commit that exposed them.
A cursory search of Stack Overflow will reveal sad tales of credentials that were scraped from Github and then used to run
up very expensive bills for services that the credential owner was liable for.</p>

<h2>But what about &lsquo;secrets.yml&rsquo; in Rails?</h2>

<p>The <code>secrets.yml</code> file in Rails 4.1 was added to address this issue, bu the problem is, it&rsquo;s not really secret, and it&rsquo;s
a bit convoluted to use.  It violates these two basic rules:</p>

<ol>
<li>Don&rsquo;t store environment variables in any file that is committed to a repo.</li>
<li>Manage your <code>.gitignore</code>, and make sure your team excludes files that contain credentials.</li>
</ol>


<h2>The Solution?</h2>

<p>Like most things in the Ruby world, if it&rsquo;s a common problem there is probably a <code>gem</code> for it.</p>

<p>In this care there are two: <code>dotenv</code> &amp; <code>figaro</code>.</p>

<p>They both approach the problem in similar ways, I&rsquo;ll give the basics for using <code>dotenv</code></p>

<h3>Step 1: Gemfile</h3>

<figure class='code'><figcaption><span>Add dotenv gem to the Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ruby</span> <span class="s1">&#39;2.2.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.2.0&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;dotenv-rails&#39;</span><span class="p">,</span> <span class="n">groups</span> <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run <code>bundle install</code></p>

<h3>Step 2: Update your <code>.gitignore</code></h3>

<figure class='code'><figcaption><span>Add the .env file to .gitignore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">log</span><span class="o">/*</span>
</span><span class='line'><span class="o">.</span><span class="n">bundle</span><span class="o">/</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">env</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is important, you don&rsquo;t want to create the <code>.env</code> file before it is ignored because it&rsquo;s
extra steps to remove it if it gets accidentally committed.</p>

<h3>Step 3: Create the <code>.env</code> file</h3>

<p>The <code>.env</code> file is a hidden file that will hold your environment variables.</p>

<figure class='code'><figcaption><span>Example .env file</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SECRET_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;2398sljae23lkj;2&#39;</span>
</span><span class='line'><span class="no">S3_BUCKET_NAME</span> <span class="o">=</span> <span class="s1">&#39;portal-device&#39;</span>
</span><span class='line'><span class="no">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s1">&#39;052kjJKW620&#39;</span>
</span><span class='line'><span class="no">SENDGRID_API</span> <span class="o">=</span> <span class="s1">&#39;Twer2590lkQ5&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Step 4: Configure secrets.yml and your initializers</h3>

<p>Your Rails app needs to know how to get to these ENV variables, so you&rsquo;ll pass them in
from either secrets.yml or the initializers for your service, e.g.</p>

<figure class='code'><figcaption><span>secrets.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">development</span><span class="p">:</span>
</span><span class='line'><span class="ss">secret_key_base</span><span class="p">:</span> <span class="o">&lt;</span><span class="sx">%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span>
</span><span class='line'><span class="sx">omniauth_provider_key: &lt;%=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;SENDGRID_API&quot;</span><span class="o">]</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">omniauth_provider_secret: &lt;%= ENV[&quot;AWS_ACCESS_KEY_ID&quot;] %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span><span class="p">:</span>
</span><span class='line'><span class="ss">secret_key_base</span><span class="p">:</span> <span class="o">&lt;</span><span class="sx">%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span>
</span><span class='line'><span class="sx">send_gred_key: &lt;%=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;SENDGRID_API&quot;</span><span class="o">]</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">aws_access_key: &lt;%= ENV[&quot;AWS_ACCESS_KEY_ID&quot;] %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">production</span><span class="p">:</span>
</span><span class='line'><span class="ss">secret_key_base</span><span class="p">:</span> <span class="o">&lt;</span><span class="sx">%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span>
</span><span class='line'><span class="sx">send_gred_key: &lt;%=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;SENDGRID_API&quot;</span><span class="o">]</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">aws_access_key: &lt;%= ENV[&quot;AWS_ACCESS_KEY_ID&quot;] %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Step 5: Set the variables in production</h3>

<p>Make sure to set your environment variables in your production VPS, either from the
web interface or via the command line.  For heroku this would be look like this:</p>

<p><code>heroku config:set SECRET_TOKEN=45FEW%dak27ks</code></p>

<h3>Step 6: Distribute to your development team</h3>

<p>Make the <code>.env</code> file available to your collaborators, but do it via a secure means.  That
means don&rsquo;t use Dropbox, Slack, HipChat, etc.  Also make sure that everyone has pulled the
git commit that updated <code>.gitignore</code> to ignore the the <code>.env</code> file and use the <code>dotenv</code> gem.</p>

<h3>Resources</h3>

<p><a href="guides.rubyonrails.org/configuring.html">Rails Guides: Configuring Rails Applications</a></p>

<p><a href="railsapps.github.io/rails-environment-variables.html">Rails App Project: Rails Environment Variables</a></p>

<p><a href="github.com/bkeepers/dotenv">dotenv gem</a></p>

<p><a href="github.com/laserlemon/figaro">figaro gem</a></p>

<p><a href="brandonhilkert.com/blog/using-rails-4-dot-1-secrets-for-configuration">Brandon Hilkert Blog: Using Rails 4.1 Secrets for Configuration</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Upgrading OS X PostgreSQL App to 9.4]]></title>
    <link href="http://bayendor.github.io/blog/2014/12/20/upgrading-to-postgres-9-dot-4-on-os-x/"/>
    <updated>2014-12-20T10:58:28-07:00</updated>
    <id>http://bayendor.github.io/blog/2014/12/20/upgrading-to-postgres-9-dot-4-on-os-x</id>
    <content type="html"><![CDATA[<p>Postgres 9.4 has finally shipped. This long awaited release includes numerous upgrades,
including native support for JSON, and improved scalability and index performance.</p>

<p>Upgrading to Postgres 9.4.0 is not as simple as merely replacing your current 9.3.x version with the newer
version. The release notes indicate that users who wish to upgrade must first migrate their existing data
from prior versions using one of two strategies: <code>pg_dumpall</code> or <code>pg_upgrade</code>.</p>

<p>There are typically two ways that OS X users install Postgres on their machine: via the OS X native <a href="http://postgresapp.com">Postgres.app</a> (the one with the blue elephant icon) or using the package manager <code>homebrew</code>.</p>

<p>I&rsquo;ll provide instructions for <a href="http://postgresapp.com">Postgres.app</a> using <code>pg_dumpall</code> to upgrade on OS X.</p>

<p>If you installed with <code>homebrew</code> follow the excellent instructions found here: <a href="http://cl.ly/ZF5l">Keita&rsquo;s Blog: Homebrew and PostgreSQL 9.4</a></p>

<h2>1: Export your existing databases to a SQL script file</h2>

<p>Postgres stores databases in version specific directories.  So before we get started we need to know what
the current Postgres data directory is for the installed version.  Fire up your postgres console
and find out with <code>SHOW data_directory;</code>.  Your output may look different, but what we want is the path that
is returned.  On my machine it looked like this:</p>

<figure class='code'><figcaption><span>Using psql to locate the data directory</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">psql</span>
</span><span class='line'><span class="k">Null</span> <span class="n">display</span> <span class="k">is</span> <span class="ss">&quot;[NULL]&quot;</span><span class="p">.</span>
</span><span class='line'><span class="n">Expanded</span> <span class="n">display</span> <span class="k">is</span> <span class="n">used</span> <span class="n">automatically</span><span class="p">.</span>
</span><span class='line'><span class="n">psql</span> <span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="k">Type</span> <span class="ss">&quot;help&quot;</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">localhost</span> <span class="o">@</span><span class="n">David</span><span class="o">=#</span> <span class="k">SHOW</span> <span class="n">data_directory</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                      <span class="n">data_directory</span>
</span><span class='line'><span class="c1">-----------------------------------------------------------</span>
</span><span class='line'> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">David</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Application</span> <span class="n">Support</span><span class="o">/</span><span class="n">Postgres</span><span class="o">/</span><span class="n">var</span><span class="o">-</span><span class="mi">9</span><span class="p">.</span><span class="mi">3</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">localhost</span> <span class="o">@</span><span class="n">David</span><span class="o">=#</span> <span class="err">\</span><span class="n">q</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make a note of this directory.  Once the data has been migrated and you&rsquo;ve confirmed everything is
working you&rsquo;ll probably want to delete the old copy to free up space.</p>

<p>Next export the existing 9.3 databases out of that directory prior to upgrading to 9.4:</p>

<figure class='code'><figcaption><span>Using pg_dumpall to create a single SQL script file for migration to 9.4</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir pg_migrate
</span><span class='line'><span class="nb">cd </span>pg_migrate
</span><span class='line'>pg_dumpall &gt; db.out
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s worth noting that like many unix commands you will get no feedback from this command while it is running.
Depending on how many and/or how large your pg databases are this may take a while.  When you are returned to
your standard shell prompt run <code>ls</code> and if you see <code>db.out</code> you are ready to go.</p>

<h2>2: Download the latest <a href="http://postgresapp.com">Postgres.app</a></h2>

<p>Click the elephant icon in the OS X menubar and choose <code>quit</code> to stop the server.</p>

<p>Go to your Applications directory and find the Postgres app (the blue elephant icon). Rename it to
Postgres.old.</p>

<p>Go to <a href="http://postgresapp.com">http://postgresapp.com</a> and download the latest version.  Double cick the downloaded zip file and drag
the new Postgres app into your Applications folder.</p>

<p>Double click the icon and wait for the application to start.  From either the elephant icon in the menu bar
or the <code>psql</code> command check the version number. It should be 9.4.0.</p>

<h2>3: Import the SQL dump into the new server directory.</h2>

<p>From the directory where you ran <code>pg_dumpall</code> in step 1 run the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>psql -f db.out postgres
</span></code></pre></td></tr></table></div></figure>


<p>Unlike the original <code>pg_dumpall</code> command you will see a lot of activity on the screen, including some warnings
that look like errors.  This is expected output, so be patient while the databases are recreated in the new 9.4
server directory.</p>

<p>Once you get your command prompt back, go into the <code>psql</code> console and check you databases are all there the
command <code>\l</code>. At a minimum you should have output like the example below, where one database typically has
your OSX or postgres admin username, two are templates, and one is postgres:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">psql</span>
</span><span class='line'><span class="k">Null</span> <span class="n">display</span> <span class="k">is</span> <span class="ss">&quot;[NULL]&quot;</span><span class="p">.</span>
</span><span class='line'><span class="n">Expanded</span> <span class="n">display</span> <span class="k">is</span> <span class="n">used</span> <span class="n">automatically</span><span class="p">.</span>
</span><span class='line'><span class="n">psql</span> <span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">Type</span> <span class="ss">&quot;help&quot;</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">localhost</span> <span class="o">@</span><span class="n">David</span><span class="o">=#</span> <span class="err">\</span><span class="n">l</span>
</span><span class='line'>                                       <span class="n">List</span> <span class="k">of</span> <span class="n">databases</span>
</span><span class='line'>            <span class="n">Name</span>             <span class="o">|</span> <span class="k">Owner</span> <span class="o">|</span> <span class="k">Encoding</span> <span class="o">|</span>   <span class="k">Collate</span>   <span class="o">|</span>    <span class="n">Ctype</span>    <span class="o">|</span> <span class="k">Access</span> <span class="k">privileges</span>
</span><span class='line'><span class="c1">-----------------------------+-------+----------+-------------+-------------+-------------------</span>
</span><span class='line'> <span class="n">David</span>                       <span class="o">|</span> <span class="n">David</span> <span class="o">|</span> <span class="n">UTF8</span>     <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span>
</span><span class='line'> <span class="n">postgres</span>                    <span class="o">|</span> <span class="n">David</span> <span class="o">|</span> <span class="n">UTF8</span>     <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span>
</span><span class='line'> <span class="n">template0</span>                   <span class="o">|</span> <span class="n">David</span> <span class="o">|</span> <span class="n">UTF8</span>     <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span> <span class="o">=</span><span class="k">c</span><span class="o">/</span><span class="n">David</span>         <span class="o">+</span>
</span><span class='line'>                             <span class="o">|</span>       <span class="o">|</span>          <span class="o">|</span>             <span class="o">|</span>             <span class="o">|</span> <span class="n">David</span><span class="o">=</span><span class="n">CTc</span><span class="o">/</span><span class="n">David</span>
</span><span class='line'> <span class="n">template1</span>                   <span class="o">|</span> <span class="n">David</span> <span class="o">|</span> <span class="n">UTF8</span>     <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span> <span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="o">|</span> <span class="n">David</span><span class="o">=</span><span class="n">CTc</span><span class="o">/</span><span class="n">David</span>  <span class="o">+</span>
</span><span class='line'>                             <span class="o">|</span>       <span class="o">|</span>          <span class="o">|</span>             <span class="o">|</span>             <span class="o">|</span> <span class="o">=</span><span class="k">c</span><span class="o">/</span><span class="n">David</span>
</span><span class='line'><span class="p">(</span><span class="mi">4</span> <span class="k">rows</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">localhost</span> <span class="o">@</span><span class="n">David</span><span class="o">=#</span> <span class="err">\</span><span class="n">q</span>
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>4: Clean up the export file and the old data directory</h2>

<p>Verify that your applications can access your databases, and that everything is working as expected.
Once you are comfortable with that you have some cleaning up to do.</p>

<p>Backup or delete the <code>db.out</code> file.</p>

<p>If you are using <code>postgres.app</code> delete the <code>postgres.old</code> application from your Applications folder.</p>

<p>Finally using the <code>SHOW data_directory;</code> command from step 1, verify that the new directory is not the same
as the old one, and then you can safely delete the old database directory.  In my case the old directory was
<code>~/Library/Application Support/Postgres/var-9.3</code>, and the new one is now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">psql</span>
</span><span class='line'><span class="k">Null</span> <span class="n">display</span> <span class="k">is</span> <span class="ss">&quot;[NULL]&quot;</span><span class="p">.</span>
</span><span class='line'><span class="n">Expanded</span> <span class="n">display</span> <span class="k">is</span> <span class="n">used</span> <span class="n">automatically</span><span class="p">.</span>
</span><span class='line'><span class="n">psql</span> <span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">Type</span> <span class="ss">&quot;help&quot;</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">localhost</span> <span class="o">@</span><span class="n">David</span><span class="o">=#</span> <span class="k">SHOW</span> <span class="n">data_directory</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">data_directory</span>
</span><span class='line'><span class="c1">-----------------------------------------------------------</span>
</span><span class='line'> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">David</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Application</span> <span class="n">Support</span><span class="o">/</span><span class="n">Postgres</span><span class="o">/</span><span class="n">var</span><span class="o">-</span><span class="mi">9</span><span class="p">.</span><span class="mi">4</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can remove or backup the old directory at your discretion.</p>

<p>That completes your upgrade to 9.4.0.  For any patch revisions, i.e. <code>9.4.x</code>, that come later you can simply upgrade the postgres application by downloading the newer <a href="http://postgresapp.com">Postgres.app</a> and installing it over the old version.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Parsing Command Line Input]]></title>
    <link href="http://bayendor.github.io/blog/2014/10/03/parsing-command-line-interfaces/"/>
    <updated>2014-10-03T11:20:03-06:00</updated>
    <id>http://bayendor.github.io/blog/2014/10/03/parsing-command-line-interfaces</id>
    <content type="html"><![CDATA[<p>One of the biggest challenges with a terminal/command line driven interface (CLI) is parsing out the relavent pieces of the input.  For a lot of web and touch based interfaces this kind of input is constrained by input widgets.</p>

<p>We recently completed an &lsquo;Event Reporter&rsquo; project, and it allows the user to interact with a library of data about attendees to an event. Commands would include: <code>find last_name Smith</code>, <code>load data.csv</code>, <code>save to results.csv</code>, or <code>queue count</code> and <code>queue print</code>.</p>

<p>Ruby provides a capable set of methods for breaking input into strings and arrays, which then allows you to manipulate and extract the parts that are meaningful so they can be passed as messages to the other classes in the application.</p>

<p>The basic CLI requires a REPL loop that Reads input, Evaluates it, Prints a response, and repeats until some condition is met that terminates the loop.</p>

<p>These are examples of how we tackled some of the problems we came up against:</p>

<figure class='code'><figcaption><span>The initial REPL loop</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">start</span>
</span><span class='line'>    <span class="n">printer</span><span class="o">.</span><span class="n">intro</span>
</span><span class='line'>    <span class="k">until</span> <span class="n">finished?</span>
</span><span class='line'>      <span class="n">printer</span><span class="o">.</span><span class="n">command_request</span>
</span><span class='line'>      <span class="n">process_command</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">printer</span><span class="o">.</span><span class="n">ending</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the code snippet above, the two methods on lines 4 &amp; 5 handle the request for input and then pass that input off for processing.</p>

<p>The <code>process_command</code> method is a <code>case</code> statement that has boolean conditions based on the input received, and for each type of command request, breaks the command down to extract the required content.  For example, the command <code>load</code> has two conditions: as a single term that will load a default file, and with a filename that will load a given file.  One strategy looks like this:</p>

<figure class='code'><figcaption><span>Parsing the LOAD request</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">when</span> <span class="nb">load</span><span class="p">?</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@input</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">load_file</span><span class="p">(</span><span class="vi">@input</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">load_file</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="o">[.</span><span class="n">.</span><span class="o">.]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we already know that the second (or last) part of the command is going to be the filename, so we use <code>length</code> to determine that condition, and then pass the corresponding string out of the <code>@input</code> array to the <code>load()</code> method.  The <code>load</code> method has it&rsquo;s own logic to check if a file exists, and handle malformed file names, since that is not a command parsing responsiblity.</p>

<p>When evaluating the <code>find</code> method there are three components to the command, <code>find</code>, <code>criteria</code>, i.e. state, city, etc., and the <code>term</code> to search against, &lsquo;CO&rsquo; or &lsquo;Denver&rsquo;.  However the <code>term</code> may be consist of multiple words, such as &lsquo;New Orleans&rsquo;.  Because we decompose the command into an array, split on spaces, the search term needs to be reconsituted.  One way to approach that might look like this:</p>

<figure class='code'><figcaption><span>Parsing the FIND request with multi-word term</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">when</span> <span class="n">find</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@input</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">value</span> <span class="o">=</span> <span class="n">input</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.input</span><span class="o">.</span><span class="n">length</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@repository</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="vi">@input</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="n">printer</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="vi">@repository</span><span class="o">.</span><span class="n">results_count</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">printer</span><span class="o">.</span><span class="n">not_a_valid_command</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="o">[.</span><span class="n">.</span><span class="o">.]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In a similar strategy to the <code>load</code> method, we evaluate how long the input request is.  Then we go after the <code>criteria</code> and the <code>term</code>.  Criteria is the second element in the array after the command, so that is handled with <code>input[1]</code> (remembering that Ruby is zero-indexed).</p>

<p>The search term or criteria is all the remaining string elements of the array, so we get that value on line 3 by re-combining all the array elements from <code>[input[2]..input.length]</code> and then <code>.join(" ")</code> them with a space between.  The resulting terms are then handled off to the <code>repository</code> on line 4 to the <code>find(criteria, search_term)</code> method.</p>

<p>As part of the evaluation of our project, all of this parsing logic should eventually be refactored into a separate class of it&rsquo;s own, but that&rsquo;s a topic for another post.</p>
]]></content>
  </entry>
  
</feed>
